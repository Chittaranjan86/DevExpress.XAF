variables:
  PastBuild: false
  Latest: false
  NUGET_PACKAGES: $(Pipeline.Workspace)/.nuget/packages
jobs:
- job: BuildTests
  strategy: 
    parallel: 1
  pool:
    vmImage: windows-2019
  variables:
    - group: keys
  steps:
  - checkout: self
  - task: DownloadBuildArtifacts@0
    displayName: "Download Bin"
    inputs:
        buildType: 'specific'
        project: 'dc0010e5-9ecf-45ac-b89d-2d51897f3855'
        pipeline: '23'
        buildVersionToDownload: 'latest'
        downloadType: 'single'
        artifactName: 'bin'
        downloadPath: '$(System.DefaultworkingDirectory)'
  - task: DownloadBuildArtifacts@0
    displayName: "Download Source"
    inputs:
        buildType: 'specific'
        project: 'dc0010e5-9ecf-45ac-b89d-2d51897f3855'
        pipeline: '23'
        buildVersionToDownload: 'latest'
        downloadType: 'single'
        artifactName: 'source'
        downloadPath: '$(System.DefaultworkingDirectory)'
  - task: PowerShell@2
    displayName: Restore State
    inputs:
      targetType: inline
      script: |
        dotnet tool restore
        Get-ChildItem $(System.DefaultworkingDirectory)\src -Exclude Tests|Remove-Item -Recurse -Force -Verbose
        Get-ChildItem $(System.DefaultworkingDirectory)\Source\src -Exclude Tests|foreach{
          Move-Item $_ $(System.DefaultworkingDirectory)\src -Verbose -Force
        }
        # Remove-Item $(System.DefaultworkingDirectory)\paket.dependencies
        Remove-Item $(System.DefaultworkingDirectory)\Source -Recurse -Force
        # Get-Content $(System.DefaultworkingDirectory)\paket.dependencies -Raw
        Get-Content $(System.DefaultworkingDirectory)\src\tests\all\paket.dependencies -Raw
  - task: CacheBeta@0
    inputs:
      key: paket | paket.lock
      path: .\packages
    displayName: Cache NuGet packages
  - task: PowerShell@2
    displayName: Copy Packages
    inputs:
      targetType: inline
      script: |
        "Workspace=$(Pipeline.Workspace)"
        Copy-Item $(System.DefaultworkingDirectory)\packages $(Pipeline.Workspace)/.nuget/packages -Recurse -Force -Verbose
  - task: PowerShell@2
    displayName: Build
    inputs:
      targetType: inline
      script: |
        & $(System.DefaultworkingDirectory)\tools\build\BuildTestsPipeline.ps1 '$(System.DefaultworkingDirectory)' $(DXApiFeed)
      pwsh: true
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: UnitTests'
    inputs:
      PathtoPublish: '$(System.DefaultworkingDirectory)\buildstage\bin'
      ArtifactName: 'Bin'
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: XafApplication'
    inputs:
      PathtoPublish: '$(System.DefaultworkingDirectory)\buildstage\Tests'
      ArtifactName: 'Tests'