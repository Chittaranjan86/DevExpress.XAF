variables:
  PastBuild: false
  Latest: false

trigger: none
jobs:
- job: BuildArtifacts
  strategy:
    parallel: 1
  pool:
    vmImage: windows-latest
  variables:
    - group: keys
  steps:
    - checkout: self
    - task: DownloadBuildArtifacts@0
      displayName: Download Bin
      inputs:
        buildType: 'specific'
        project: 'dc0010e5-9ecf-45ac-b89d-2d51897f3855'
        definition:  '23'
        buildVersionToDownload: 'latest'
        artifactName: 'bin'
        downloadPath:  '$(System.DefaultWorkingDirectory)'
        downloadType: single 
    # - task: DownloadPipelineArtifact@2
    #   displayName: Download EasyTests
    #   inputs:
    #     buildType: 'specific'
    #     project: 'dc0010e5-9ecf-45ac-b89d-2d51897f3855'
    #     definition: '23'
    #     buildVersionToDownload: 'latest'
    #     artifactName: 'Tests'
    #     targetPath: '$(System.DefaultWorkingDirectory)\bin'
    - task: AzurePowerShell@4
      displayName: BuildArtifacts
      inputs:
        azureSubscription: 'Visual Studio Enterprise (b48a609a-17f6-4e48-a317-54ab77fbf822)'
        ScriptType: InlineScript
        azurePowerShellVersion: 'LatestVersion'
        Inline: |
          & '$(System.DefaultWorkingDirectory)/tools/build/TestPipeline.ps1' '$(System.DefaultWorkingDirectory)' '($AzureToken)'
    - task: PublishPipelineArtifact@1
      # condition: $(NewArtifact)
      displayName: 'Publish Artifact: Bin'
      inputs:
        targetPath: '$(System.DefaultWorkingDirectory)\bin'
        ArtifactName: 'Bin'
# - job: TestPerAssembly
#   dependsOn: 'BuildArtifacts'
#   strategy:
#     parallel: 15
#   pool:
#     vmImage: windows-latest
#   variables:
#     - group: keys
#   steps:
#     - checkout: self
#     - task: DownloadBuildArtifacts@0
#       displayName: Download Bin
#       inputs:
#         buildType: 'current'
#         downloadType: 'single'
#         artifactName: 'bin'
#         downloadPath: '$(System.DefaultWorkingDirectory)'
#     - task: VSTest@2
#       displayName: 'Test Modules'
#       continueOnError: true
#       inputs:
#         searchFolder: '$(System.DefaultWorkingDirectory)'
#         testSelector: 'testAssemblies'
#         testAssemblyVer2: |
#           # **\*All*Tests.dll
#           **\*AutoCommit*Tests.dll
#           **\*CloneMemberValue*Tests.dll
#           **\*CloneModelView*Tests.dll
#           **\*Extensions*Tests.dll
#           **\*Testslib.dll
#           **\*Grid*Tests.dll
#           **\*HideTool*Tests.dll
#           **\*Logger.Tests.dll
#           **\*MasterDet*Tests.dll
#           **\*ModelViewIn*Tests.dll
#           **\*OneView*Tests.dll
#           **\*Progre*Tests.dll
#           **\*Reactive.Tests.dll
#           **\*Refresh*Tests.dll
#           **\*Supp*Tests.dll
#           **\*View*Tests.dll
#           !**\*Hub*.dll
#           !**\*TestAdapter.dll
#           !**\obj\**    
#         diagnosticsEnabled: true
#         codeCoverageEnabled: true
#         distributionBatchType: basedOnAssembly
#         runInParallel: false
#         runSettingsFile: .\bin\Tests.runsettings
#         runTestsInIsolation: false
#         collectDumpOn: never
- job: TestPerExecutionTime
  dependsOn: 'BuildArtifacts'
  # dependsOn: 'TestPerAssembly'
  strategy:
    parallel: 10
  pool:
    vmImage: windows-latest
  variables:
    - group: keys
  steps:
    - checkout: none
    - task: DownloadPipelineArtifact@2
      displayName: Download Bin
      inputs:
        buildType: 'current'
        artifactName: 'bin'
        targetPath: '$(System.DefaultWorkingDirectory)'
    - task: VSTest@2
      displayName: 'Tests'
      continueOnError: true
      inputs:
        searchFolder: '$(System.DefaultWorkingDirectory)'
        testSelector: 'testAssemblies'
        testAssemblyVer2: |
          **\*All*Tests.dll
          **\*ModelMapper*Tests.dll
          !**\obj\**    
        diagnosticsEnabled: true
        codeCoverageEnabled: true
        distributionBatchType: basedOnExecutionTime
        runInParallel: false
        runSettingsFile: .\bin\Tests.runsettings
        runTestsInIsolation: false
        collectDumpOn: never
- job: CheckTests
  dependsOn: TestPerExecutionTime
  pool:
    vmImage: windows-latest
  variables:
    - group: keys
  steps:
    - checkout: self
    - task: AzurePowerShell@4
      displayName: BuildArtifacts
      inputs:
        azureSubscription: 'Visual Studio Enterprise (b48a609a-17f6-4e48-a317-54ab77fbf822)'
        ScriptType: InlineScript
        azurePowerShellVersion: 'LatestVersion'
        Inline: |
          # $azurePassword = ConvertTo-SecureString $xpandBlobOwnerSecret -AsPlainText -Force
          # $psCred = New-Object System.Management.Automation.PSCredential($azureAplicationId , $azurePassword)
          # Connect-AzAccount -Credential $psCred -TenantId $subscriptionTenantId  -ServicePrincipal 